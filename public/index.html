<!DOCTYPE html><html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Dashboard Pelaporan Interaktif</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  *{box-sizing:border-box;}
  body{font-family:"Inter","Segoe UI",sans-serif;background:#f3f4f6;margin:0;color:#333;}
  header{background:#1e40af;color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
  header h1{font-size:20px;margin:0;font-weight:600;}
  nav button{background:transparent;border:none;color:#dbeafe;font-weight:600;cursor:pointer;margin:0 10px;font-size:14px;padding-bottom:4px;border-bottom:2px solid transparent;}
  nav button.active{color:white;border-bottom:2px solid white;}
  section{display:none;padding:24px;animation:fadeIn 0.3s ease;}
  section.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .card{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.05);padding:20px;margin-bottom:20px;}
  table{border-collapse:collapse;width:100%;background:white;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;}
  th{background-color:#f9fafb;text-align:left;}
  img{width:90px;border-radius:6px;border:1px solid #ccc;}
  select,input[type=file],button.upload-btn,input[type=number],input[type=text],input[type=month]{padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:6px;font-size:14px;}
  .upload-btn{background:#1e40af;color:white;cursor:pointer;border:none;transition:background 0.2s;}
  .upload-btn:hover{background:#2563eb;}
  .filter{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px;}
  .filter label{font-weight:500;}
  footer{text-align:center;padding:15px;background:#e5e7eb;font-size:13px;color:#555;}
</style>
</head>
<body>
<header>
<h1>üìã Dashboard Pelaporan</h1>
<nav>
<button id="tab1" class="active">Dashboard</button>
<button id="tab2">Upload Template</button>
<button id="tab3">Rekap Laporan</button>
<button id="tab4">Input Target</button>
</nav>
</header><!-- DASHBOARD --><section id="page1" class="active">
<div class="card">
<h2>üìà Statistik Laporan</h2>
<canvas id="reportChart" height="120"></canvas>
</div>
<div class="card">
<p><b>Total laporan:</b> <span id="totalReports">0</span></p>
<p><b>Kategori terbanyak:</b> <span id="topCategory">-</span></p>
</div>
</section><!-- UPLOAD TEMPLATE --><section id="page2">
<div class="card">
<h2>üìÅ Upload Template Report</h2>
<p>Unggah file laporan (CSV/Excel) ke Supabase Storage (<code>template</code>).</p>
<input type="file" id="templateFile" accept=".csv,.xlsx,.xls">
<br>
<button class="upload-btn" onclick="uploadTemplate()">Upload File</button>
<p id="uploadStatus"></p>
</div>
</section><!-- REKAP LAPORAN --><section id="page3">
<div class="card">
<h2>üóÇÔ∏è Rekap Laporan Telegram</h2>
<div class="filter">
<label>Kategori:
<select id="filterCategory">
<option value="">Semua</option>
<option value="Jalan">Jalan</option>
<option value="Jembatan">Jembatan</option>
<option value="Tiang">Tiang</option>
<option value="Kabel">Kabel</option>
<option value="Lainnya">Lainnya</option>
</select>
</label>
<button class="upload-btn" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
</div>
<div style="overflow-x:auto;">
<table id="reportTable">
<thead>
<tr>
<th>Tanggal</th><th>Kategori</th><th>Nama Pekerjaan</th><th>Volume</th><th>Material</th><th>Keterangan</th><th>Lokasi</th><th>Foto Sebelum</th><th>Foto Sesudah</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section><!-- INPUT TARGET --><section id="page4">
<div class="card">
<h2>üéØ Input Target Bulanan</h2>
<label>Bulan / Tahun: <input type="month" id="targetMonth"></label><br><br>
<label>Kategori:
<select id="targetCategory">
<option value="Jalan">Jalan</option>
<option value="Jembatan">Jembatan</option>
<option value="Tiang">Tiang</option>
<option value="Kabel">Kabel</option>
<option value="Lainnya">Lainnya</option>
</select>
</label><br><br>
<label>Target Laporan: <input type="number" id="targetValue"></label><br><br>
<button class="upload-btn" onclick="saveTarget()">Simpan Target</button>
<p id="targetStatus"></p>
</div>
</section><footer>¬© 2025 Sistem Pelaporan | Supabase + Telegram Bot</footer><script>
const supabase = supabase.createClient(
"https://zpcuzrifbisrcjtqgqyv.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg"
);

// NAVIGATION
const tabs=document.querySelectorAll("nav button");
const pages=document.querySelectorAll("section");
tabs.forEach((tab,i)=>{
tab.addEventListener("click",()=>{
tabs.forEach(t=>t.classList.remove("active"));
pages.forEach(p=>p.classList.remove("active"));
tab.classList.add("active");
pages[i].classList.add("active");
});
});

// ESCAPE HTML
function escapeHTML(str){return str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):"";}

// UPLOAD TEMPLATE
async function uploadTemplate(){
const file=document.getElementById("templateFile").files[0];
const status=document.getElementById("uploadStatus");
if(!file)return status.textContent="‚ùå Pilih file terlebih dahulu.";
const {error}=await supabase.storage.from("template").upload(`template/${Date.now()}-${file.name}`,file);
status.textContent=error?"‚ùå Upload gagal: "+error.message:"‚úÖ Upload berhasil!";
}

// LOAD REPORTS
async function loadReports(filter="", monthFilter=""){
try{
let query = supabase.from("reports").select("*").order("created_at",{ascending:false});
if(filter) query=query.eq("category",filter);
const {data,error}=await query;
if(error){console.error("Supabase select error:",error);return;}
let filtered = data || [];
if(monthFilter){
  filtered = filtered.filter(r=>{
    const d=new Date(r.created_at);
    const monthStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    return monthStr===monthFilter;
  });
}
renderTable(filtered);
updateDashboard(filtered);
}catch(e){console.error("loadReports error:",e);}
}

// RENDER TABLE
function renderTable(data){
const tbody=document.querySelector("#reportTable tbody");
tbody.innerHTML="";
data.forEach(r=>{
const lat=r.latitude!=null?Number(r.latitude).toFixed(5):'-';
const lon=r.longitude!=null?Number(r.longitude).toFixed(5):'-';
const photoBefore=r.photo_before_url||r.photo_url||'-';
const photoAfter=r.photo_after_url||'-';
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${r.created_at?new Date(r.created_at).toLocaleString():'-'}</td>
<td>${escapeHTML(r.category)}</td>
<td>${escapeHTML(r.nama_pekerjaan)}</td>
<td>${escapeHTML(r.volume_pekerjaan)}</td>
<td>${escapeHTML(r.material)}</td>
<td>${escapeHTML(r.keterangan)}</td>
<td>${lat}, ${lon}</td>
<td>${photoBefore!=='-'?`<img src="${photoBefore}">`:'-'}</td>
<td>${photoAfter!=='-'?`<img src="${photoAfter}">`:'-'}</td>
`;
tbody.appendChild(tr);
});
}

// UPDATE DASHBOARD
function updateDashboard(data){
const total=data.length;
document.getElementById("totalReports").textContent=total;
const counts={};
data.forEach(d=>counts[d.category]=(counts[d.category]||0)+1);
const categories=Object.keys(counts);
const values=Object.values(counts);
document.getElementById("topCategory").textContent=categories.length?categories[values.indexOf(Math.max(...values))]:"-";
renderChart(categories,values);
}

let chart;
function renderChart(labels,values){
const ctx=document.getElementById("reportChart").getContext("2d");
if(chart) chart.destroy();
chart=new Chart(ctx,{
type:"bar",
data:{labels,datasets:[{label:"Jumlah Laporan",data:values,backgroundColor:"#2563eb"}]},
options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
});
}

// FILTER & CSV
document.getElementById("filterCategory").addEventListener("change",e=>loadReports(e.target.value,document.getElementById("targetMonth").value));
async function downloadCSV(){
const {data}=await supabase.from("reports").select("*");
if(!data.length)return alert("Tidak ada data untuk diunduh.");
const header=Object.keys(data[0]);
const rows=data.map(o=>header.map(h=>`"${o[h]||""}"`).join(","));
const csv=[header.join(","),...rows].join("\n");
const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download=`report-${new Date().toISOString()}.csv`;
a.click();
}

// INPUT TARGET
async function saveTarget(){
const month=document.getElementById("targetMonth").value;
const category=document.getElementById("targetCategory").value;
const value=Number(document.getElementById("targetValue").value);
const status=document.getElementById("targetStatus");
if(!month||!category||!value)return status.textContent="‚ùå Lengkapi semua field!";
const {error}=await supabase.from("targets").upsert([{month,category,target:value}]);
status.textContent=error?"‚ùå Gagal simpan target: "+error.message:"‚úÖ Target berhasil disimpan!";
loadReports(document.getElementById("filterCategory").value, month);
}

// FILTER BULAN TARGET
document.getElementById("targetMonth").addEventListener("change",e=>{
  loadReports(document.getElementById("filterCategory").value,e.target.value);
});

// INITIAL LOAD
loadReports();
</script></body>
</html>
