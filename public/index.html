<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Kemajuan Project</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2563eb;
      --muted:#6b7280;
      --bg:#f3f4f6;
      --card:#ffffff;
      --success:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --radius:10px;
      --maxwidth:1000px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:linear-gradient(90deg,var(--primary),#4b67f6);
      color:white;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 8px rgba(15,23,42,0.08);
    }
    header h1{margin:0;font-size:18px;font-weight:600}
    nav a{color:rgba(255,255,255,0.95);margin-left:14px;text-decoration:none;cursor:pointer;font-weight:500}
    nav a.active{text-decoration:underline}
    main{max-width:var(--maxwidth);margin:20px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;margin-bottom:18px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}
    .summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .metric{background:linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0.03));border-radius:8px;padding:12px}
    .metric .label{font-size:13px;color:var(--muted)}
    .metric .value{font-weight:700;font-size:18px;margin-top:6px}
    .cat-list{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .cat-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0}
    .cat-name{font-weight:600}
    .cat-meta{font-size:13px;color:var(--muted)}
    .progress-track{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden;width:220px}
    .progress-fill{height:100%;border-radius:999px}
    .small{font-size:13px;color:var(--muted)}
    .chart-wrap{margin-top:14px;background:linear-gradient(180deg, #ffffff, #fbfdff);padding:12px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}
    th{background:#fbfbfb;color:var(--muted);font-weight:600}
    img.thumb{width:60px;height:60px;object-fit:cover;border-radius:6px}
    form.control{display:flex;flex-direction:column;gap:10px;max-width:420px}
    input,select,button{padding:10px;border-radius:8px;border:1px solid #e6edf8;font-size:14px}
    button{background:var(--primary);color:white;border:none;cursor:pointer}
    button:active{transform:translateY(1px)}
    @media (min-width:900px){
      .summary-grid{grid-template-columns:repeat(4,1fr)}
    }
    .note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Dashboard Kemajuan Project</h1>
    <nav>
      <a class="active" onclick="showTab('dashboard')">Dashboard</a>
      <a onclick="showTab('settarget')">Set Target</a>
      <a onclick="showTab('detail')">Detail Progress</a>
    </nav>
  </header>

  <main>
    <section id="dashboardTab" class="card">
      <div class="row-between">
        <div>
          <h2 style="margin:0 0 6px 0">Ringkasan & Progres</h2>
          <div class="note">Persentase dan satuan otomatis dari data laporan.</div>
        </div>
        <div id="lastUpdatedNote" class="small">--</div>
      </div>

      <div class="summary-grid" style="margin-top:12px">
        <div class="metric"><div class="label">Total Target</div><div id="totalTarget" class="value">-</div></div>
        <div class="metric"><div class="label">Total Progress</div><div id="totalProgress" class="value">-</div></div>
        <div class="metric"><div class="label">Total Progress (%)</div><div id="totalPercent" class="value">-</div></div>
        <div class="metric"><div class="label">Kategori Terdeteksi</div><div id="categoryCount" class="value">-</div></div>
      </div>

      <div id="categoriesContainer" class="cat-list"></div>
      <div class="chart-wrap"><canvas id="barChart" height="120"></canvas></div>
    </section>

    <section id="detailTab" class="card" style="display:none">
      <h2>Detail Progress</h2>
      <div class="note">Data laporan dari tabel <code>reports</code>.</div>
      <table id="reportTable">
        <thead>
          <tr>
            <th>Waktu</th><th>Kategori</th><th>Pekerjaan</th><th>Volume</th><th>Material</th><th>Keterangan</th><th>Before</th><th>After</th><th>Lokasi</th><th>Petugas</th>
          </tr>
        </thead><tbody></tbody>
      </table>
    </section>

    <section id="settargetTab" class="card" style="display:none">
      <h2>Set Target</h2>
      <form id="targetForm" class="control">
        <label>Kategori</label>
        <select id="categorySelect"><option value="">-- Pilih kategori --</option></select>
        <label>Target Volume</label>
        <input id="targetInput" type="number" min="0" placeholder="contoh: 5000" />
        <div style="display:flex;gap:8px">
          <button id="saveTargetBtn" type="submit">Simpan Target</button>
          <button id="refreshBtn" type="button" style="background:#f3f4f6;color:#0f172a">Refresh</button>
        </div>
        <div id="targetMsg" class="note" style="margin-top:8px"></div>
      </form>
    </section>
  </main>

  <footer style="text-align:center;padding:18px 0;color:var(--muted)">Â© 2025 Dashboard Project - Backbone Lite</footer>

  <script>
    const SUPABASE_URL = "https://zpcuzrifbisrcjtqgqyv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let barChartInstance = null;

    function progressColor(p){if(isNaN(p))return'#c7cdd8';if(p>=80)return'#16a34a';if(p>=40)return'#f59e0b';return'#ef4444';}
    function fmt(n){return n==null?'-':Number(n).toLocaleString('id-ID');}
    function satuan(cat){
      const c=cat.toLowerCase();
      if(c.includes('kabel'))return'm';
      if(c.includes('tiang'))return'pcs';
      if(c.includes('galian'))return'titik';
      if(c.includes('jalan'))return'm';
      if(c.includes('jembatan'))return'm';
      return'unit';
    }

    function showTab(tab){
      document.getElementById('dashboardTab').style.display=tab==='dashboard'?'block':'none';
      document.getElementById('detailTab').style.display=tab==='detail'?'block':'none';
      document.getElementById('settargetTab').style.display=tab==='settarget'?'block':'none';
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      document.querySelector(`nav a[onclick="showTab('${tab}')"]`)?.classList.add('active');
    }

    async function loadAll(){
      const {data:reports}=await supabase.from('reports').select('*');
      const {data:targets}=await supabase.from('targets').select('*');
      document.getElementById('lastUpdatedNote').textContent='Terakhir sync: '+new Date().toLocaleString('id-ID');

      const catMap={};const order=[];
      (reports||[]).forEach(r=>{
        const cat=(r.category||'Lain-Lain').trim();
        if(!catMap[cat]){catMap[cat]={volume:0};order.push(cat);}
        catMap[cat].volume+=(+r.volume_pekerjaan||0);
      });

      const cont=document.getElementById('categoriesContainer');cont.innerHTML='';
      document.getElementById('categoryCount').textContent=order.length;

      order.forEach(cat=>{
        const v=catMap[cat].volume;
        const tObj=(targets||[]).find(t=>(t.category||'').toLowerCase()===cat.toLowerCase());
        const tgt=tObj?(+tObj.target_volume||0):0;
        const pct=tgt?((v/tgt)*100):null;
        const s=satuan(cat);
        const el=document.createElement('div');
        el.className='cat-item';
        el.innerHTML=`
          <div>
            <div class="cat-name">${cat}</div>
            <div class="cat-meta">${fmt(v)} ${s}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:600">${pct?pct.toFixed(1)+'%':'-'}</div>
            <div class="progress-track" style="margin-top:6px">
              <div class="progress-fill" style="width:${pct?Math.min(pct,100)+'%':'100%'};background:${pct?progressColor(pct):'#c7cdd8'}"></div>
            </div>
          </div>`;
        cont.appendChild(el);
      });

      const totalVol=(reports||[]).reduce((s,r)=>s+(+r.volume_pekerjaan||0),0);
      const totalTgt=(targets||[]).reduce((s,t)=>s+(+t.target_volume||0),0);
      document.getElementById('totalTarget').textContent=totalTgt?fmt(totalTgt):'-';
      document.getElementById('totalProgress').textContent=fmt(totalVol);
      document.getElementById('totalPercent').textContent=totalTgt?((totalVol/totalTgt)*100).toFixed(1)+'%':'-';

      renderBarChart(order,order.map(c=>catMap[c].volume));
      renderTable(reports);
      populateCategorySelect(order);
    }

    function renderBarChart(labels,data){
      const ctx=document.getElementById('barChart').getContext('2d');
      if(barChartInstance)barChartInstance.destroy();
      barChartInstance=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Volume',data,backgroundColor:labels.map(()=> 'rgba(37,99,235,0.85)'),borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }

    function renderTable(reports){
      const tb=document.querySelector('#reportTable tbody');tb.innerHTML='';
      (reports||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${new Date(r.created_at).toLocaleString('id-ID')}</td>
          <td>${r.category||'-'}</td>
          <td>${r.nama_pekerjaan||'-'}</td>
          <td>${fmt(r.volume_pekerjaan)}</td>
          <td>${r.material||'-'}</td>
          <td>${r.keterangan||'-'}</td>
          <td>${r.photo_before_url?`<a href="${r.photo_before_url}" target="_blank"><img class="thumb" src="${r.photo_before_url}"></a>`:'-'}</td>
          <td>${r.photo_after_url?`<a href="${r.photo_after_url}" target="_blank"><img class="thumb" src="${r.photo_after_url}"></a>`:'-'}</td>
          <td>${r.latitude&&r.longitude?`<a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank">ðŸ“Lihat</a>`:'-'}</td>
          <td>${r.telegram_name||'-'}</td>`;
        tb.appendChild(tr);
      });
    }

    function populateCategorySelect(cats){
      const sel=document.getElementById('categorySelect');
      const ph=sel.querySelector('option[value=""]');
      sel.innerHTML='';sel.appendChild(ph);
      const common=['Jalan','Tiang','Jembatan','Kabel','Galian','Lain-Lain'];
      [...new Set([...cats,...common])].forEach(c=>{
        const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);
      });
    }

    document.getElementById('targetForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const cat=document.getElementById('categorySelect').value.trim();
      const val=parseFloat(document.getElementById('targetInput').value);
      const msg=document.getElementById('targetMsg');
      if(!cat){msg.style.color='crimson';msg.textContent='Pilih kategori.';return;}
      if(!val||isNaN(val)||val<=0){msg.style.color='crimson';msg.textContent='Masukkan target valid.';return;}
      const {error}=await supabase.from('targets').upsert([{category:cat,target_volume:val}],{onConflict:['category']});
      if(error){msg.style.color='crimson';msg.textContent='Gagal menyimpan target.';}else{msg.style.color='green';msg.textContent='âœ… Target tersimpan.';setTimeout(()=>{loadAll();showTab('dashboard');},700);}
    });

    document.getElementById('refreshBtn').addEventListener('click',()=>loadAll());
    loadAll();showTab('dashboard');
  </script>
</body>
</html>
