<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Kemajuan Project</title>

  <!-- Supabase + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Minimal styling (professional, clean) -->
  <style>
    :root{
      --primary:#2563eb; /* blue */
      --muted:#6b7280;
      --bg:#f3f4f6;
      --card:#ffffff;
      --success:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --soft:#e6eefc;
      --radius:10px;
      --maxwidth:1000px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:linear-gradient(90deg,var(--primary),#4b67f6);
      color:white;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 8px rgba(15,23,42,0.08);
    }
    header h1{margin:0;font-size:18px;font-weight:600}
    nav a{color:rgba(255,255,255,0.95);margin-left:14px;text-decoration:none;cursor:pointer;font-weight:500}
    nav a.active{text-decoration:underline}
    main{max-width:var(--maxwidth);margin:20px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;margin-bottom:18px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}
    .flex{display:flex}
    .gap{gap:12px}
    .stack{display:flex;flex-direction:column}
    .row-between{display:flex;justify-content:space-between;align-items:center}
    .summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .metric{background:linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0.03));border-radius:8px;padding:12px}
    .metric .label{font-size:13px;color:var(--muted)}
    .metric .value{font-weight:700;font-size:18px;margin-top:6px}
    /* Category list */
    .cat-list{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .cat-item{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .cat-left{display:flex;align-items:center;gap:12px}
    .cat-name{font-weight:600}
    .cat-meta{font-size:13px;color:var(--muted)}
    .progress-track{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden;width:220px}
    .progress-fill{height:100%;border-radius:999px}
    .small{font-size:13px;color:var(--muted)}
    /* Charts */
    .chart-wrap{margin-top:14px;background:linear-gradient(180deg, #ffffff, #fbfdff);padding:12px;border-radius:8px}
    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}
    th{background:#fbfbfb;color:var(--muted);font-weight:600}
    img.thumb{width:60px;height:60px;object-fit:cover;border-radius:6px}
    /* form */
    form.control{display:flex;flex-direction:column;gap:10px;max-width:420px}
    input,select,button{padding:10px;border-radius:8px;border:1px solid #e6edf8;font-size:14px}
    button{background:var(--primary);color:white;border:none;cursor:pointer}
    button:active{transform:translateY(1px)}
    /* responsive */
    @media (min-width:900px){
      .summary-grid{grid-template-columns:repeat(4,1fr)}
    }
    .note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>üìä Dashboard Kemajuan Project</h1>
    <nav>
      <a class="active" onclick="showTab('dashboard')">Dashboard</a>
      <a onclick="showTab('settarget')">Set Target</a>
      <a onclick="showTab('detail')">Detail Progress</a>
    </nav>
  </header>

  <main>
    <!-- MAIN CARD: All summary + chart in 1 card -->
    <section id="dashboardTab" class="card">
      <div class="row-between">
        <div>
          <h2 style="margin:0 0 6px 0">Ringkasan & Progres</h2>
          <div class="note">Menampilkan kategori otomatis dari data laporan. Persentase hanya muncul jika target tersedia.</div>
        </div>
        <div style="text-align:right" id="lastUpdatedNote" class="small">--</div>
      </div>

      <!-- metrics row -->
      <div style="margin-top:12px" class="summary-grid">
        <div class="metric">
          <div class="label">Total Target</div>
          <div id="totalTarget" class="value">- m</div>
        </div>
        <div class="metric">
          <div class="label">Total Progress (m)</div>
          <div id="totalProgress" class="value">- m</div>
        </div>
        <div class="metric">
          <div class="label">Total Progress (%)</div>
          <div id="totalPercent" class="value">- %</div>
        </div>
        <div class="metric">
          <div class="label">Kategori Terdeteksi</div>
          <div id="categoryCount" class="value">-</div>
        </div>
      </div>

      <!-- categories + progressbars + chart in same card -->
      <div style="margin-top:16px" class="cat-list" id="categoriesContainer">
        <!-- populated by JS -->
      </div>

      <div class="chart-wrap">
        <canvas id="barChart" height="120"></canvas>
      </div>
    </section>

    <!-- DETAIL tab (table only) -->
    <section id="detailTab" class="card" style="display:none">
      <h2 style="margin:0 0 8px 0">Detail Progress</h2>
      <div class="note">Tabel menampilkan semua baris dari tabel <code>reports</code>.</div>
      <table id="reportTable">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Kategori</th>
            <th>Pekerjaan</th>
            <th>Volume (m)</th>
            <th>Material</th>
            <th>Keterangan</th>
            <th>Before</th>
            <th>After</th>
            <th>Lokasi</th>
            <th>Petugas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SET TARGET -->
    <section id="settargetTab" class="card" style="display:none">
      <h2 style="margin:0 0 8px 0">Set Target</h2>
      <div class="note">Masukkan target per kategori. Jika kategori sudah ada di tabel, akan ditambahkan baris baru.</div>
      <form id="targetForm" class="control">
        <label for="categorySelect">Kategori (ketik atau pilih)</label>
        <select id="categorySelect">
          <option value="">-- Pilih kategori --</option>
          <!-- we will also not hardcode categories; options will be appended -->
        </select>

        <label for="targetInput">Target Volume (m)</label>
        <input id="targetInput" type="number" min="0" placeholder="contoh: 5000" />

        <div style="display:flex;gap:8px">
          <button id="saveTargetBtn" type="submit">Simpan Target</button>
          <button id="refreshBtn" type="button" style="background:#f3f4f6;color:#0f172a">Refresh</button>
        </div>
        <div id="targetMsg" class="note" style="margin-top:8px"></div>
      </form>
    </section>
  </main>

  <footer style="text-align:center;padding:18px 0;color:var(--muted)">¬© 2025 Dashboard Project - Backbone Lite</footer>

  <script>
    // -------------------------
    // CONFIG: Supabase project
    // -------------------------
    const SUPABASE_URL = "https://zpcuzrifbisrcjtqgqyv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // global chart instance
    let barChartInstance = null;

    // helper: choose color based on percent
    function progressColor(pct){
      const p = Number(pct);
      if (isNaN(p)) return '#c7cdd8';
      if (p >= 80) return getComputedStyle(document.documentElement).getPropertyValue('--success') || '#16a34a';
      if (p >= 40) return getComputedStyle(document.documentElement).getPropertyValue('--warn') || '#f59e0b';
      return getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ef4444';
    }

    // helper: format number with thousand separators
    function fmt(n){
      if (n === null || n === undefined) return '-';
      return Number(n).toLocaleString('id-ID');
    }

    // show/hide tabs
    function showTab(tab){
      document.getElementById('dashboardTab').style.display = tab==='dashboard' ? 'block' : 'none';
      document.getElementById('detailTab').style.display = tab==='detail' ? 'block' : 'none';
      document.getElementById('settargetTab').style.display = tab==='settarget' ? 'block' : 'none';
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      document.querySelector(`nav a[onclick="showTab('${tab}')"]`)?.classList.add('active');
    }

    // main loader
    async function loadAll(){
      try{
        // fetch reports & targets
        const { data: reports, error: rErr } = await supabase.from('reports').select('*').order('created_at', {ascending:true});
        const { data: targets, error: tErr } = await supabase.from('targets').select('*');
        if (rErr) { console.error('reports error', rErr); return; }
        if (tErr) console.warn('targets warning', tErr);

        // timestamp note
        document.getElementById('lastUpdatedNote').textContent = 'Terakhir sync: ' + new Date().toLocaleString('id-ID');

        // compute totals
        const totalVol = (reports || []).reduce((s,r)=> s + (parseFloat(r.volume_pekerjaan)||0), 0);
        const totalTgt = (targets || []).reduce((s,t)=> s + (parseFloat(t.target_volume)||0), 0);
        document.getElementById('totalTarget').textContent = totalTgt ? fmt(totalTgt) + ' m' : '-';
        document.getElementById('totalProgress').textContent = fmt(totalVol) + ' m';
        document.getElementById('totalPercent').textContent = totalTgt ? ((totalVol/totalTgt)*100).toFixed(1) + ' %' : '-';

        // build category list from reports (unique, keep order of appearance)
        const categoryOrder = [];
        const catMap = {};
        (reports||[]).forEach(r=>{
          const key = (r.category || 'Lain-Lain').trim();
          if (!catMap[key]){
            catMap[key] = { volume: 0, reports: [] };
            categoryOrder.push(key);
          }
          const v = parseFloat(r.volume_pekerjaan) || 0;
          catMap[key].volume += v;
          catMap[key].reports.push(r);
        });

        // render category area
        const cont = document.getElementById('categoriesContainer');
        cont.innerHTML = '';
        document.getElementById('categoryCount').textContent = categoryOrder.length;

        categoryOrder.forEach(cat=>{
          const vol = catMap[cat].volume;
          // find target for this category (case-insensitive match)
          const tobj = (targets||[]).find(t => (t.category||'').toLowerCase() === cat.toLowerCase());
          const tgt = tobj ? (parseFloat(tobj.target_volume)||0) : 0;
          const percent = tgt ? ((vol / tgt)*100) : null; // null means no target
          const pctDisplay = (percent !== null) ? (percent.toFixed(1) + ' %') : 'Target belum diisi';

          // create element
          const item = document.createElement('div');
          item.className = 'cat-item';
          item.style.padding = '8px 0';
          const left = document.createElement('div');
          left.className = 'cat-left';
          left.innerHTML = `<div style="min-width:160px">
                              <div class="cat-name">${cat}</div>
                              <div class="cat-meta small">${fmt(vol)} m</div>
                            </div>`;
          const right = document.createElement('div');
          right.style.display='flex';
          right.style.flexDirection='column';
          right.style.alignItems='flex-end';
          right.innerHTML = `<div style="font-weight:600">${(percent!==null)?pctDisplay:''}</div>
                             <div class="small" style="margin-top:6px">${(percent===null)?'Target belum diisi':''}</div>
                             <div style="height:8px;margin-top:8px" class="progress-track">
                               <div class="progress-fill" style="width:${ (percent!==null) ? Math.min(percent,100) + '%' : '100%'}; background:${ (percent!==null) ? progressColor(percent) : '#c7cdd8' }"></div>
                             </div>`;

          item.appendChild(left);
          item.appendChild(right);
          cont.appendChild(item);
        });

        // prepare bar chart data
        const barLabels = categoryOrder.length ? categoryOrder : ['No data'];
        const barData = categoryOrder.length ? categoryOrder.map(c => catMap[c].volume) : [0];

        renderBarChart(barLabels, barData);

        // render detail table
        renderTable(reports);

        // populate category select (settarget tab) with unique categories from reports + common ones
        populateCategorySelect(categoryOrder);

      } catch(err){
        console.error('loadAll error', err);
      }
    }

    // render bar chart (volume per category)
    function renderBarChart(labels, data){
      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChartInstance) barChartInstance.destroy();
      barChartInstance = new Chart(ctx, {
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Volume (m)',
            data,
            backgroundColor: labels.map(()=> 'rgba(37,99,235,0.85)'),
            borderRadius:6,
          }]
        },
        options:{
          responsive:true,
          scales:{
            y:{ beginAtZero:true }
          },
          plugins:{ legend:{ display:false } }
        }
      });
    }

    // render detail table
    function renderTable(reports){
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';
      (reports||[]).forEach(r=>{
        const tr = document.createElement('tr');
        const waktu = r.created_at ? new Date(r.created_at).toLocaleString('id-ID') : '-';
        const lokasi = (r.latitude && r.longitude) ? `<a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank">üìç Lihat</a>` : '-';
        tr.innerHTML = `
          <td>${waktu}</td>
          <td>${r.category || '-'}</td>
          <td>${r.nama_pekerjaan || '-'}</td>
          <td>${fmt(r.volume_pekerjaan)}</td>
          <td>${r.material || '-'}</td>
          <td>${r.keterangan || '-'}</td>
          <td>${r.photo_before_url ? `<a href="${r.photo_before_url}" target="_blank"><img class="thumb" src="${r.photo_before_url}" /></a>` : '-'}</td>
          <td>${r.photo_after_url ? `<a href="${r.photo_after_url}" target="_blank"><img class="thumb" src="${r.photo_after_url}" /></a>` : '-'}</td>
          <td>${lokasi}</td>
          <td>${r.telegram_name || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // populate category select with existing + common options
    function populateCategorySelect(existingCats){
      const select = document.getElementById('categorySelect');
      // clear (keep placeholder)
      const placeholder = select.querySelector('option[value=""]');
      select.innerHTML = '';
      select.appendChild(placeholder);
      const commons = ['Penarikan','Galian','Tanam Tiang','Jalan','Tiang','Jembatan','Kabel','Lain-Lain'];
      const merged = Array.from(new Set([...existingCats, ...commons]));
      merged.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    // === form: set target ===
    document.getElementById('targetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const cat = document.getElementById('categorySelect').value.trim();
      const val = parseFloat(document.getElementById('targetInput').value);
      const msgEl = document.getElementById('targetMsg');
      msgEl.textContent = '';

      if (!cat){
        msgEl.style.color = 'crimson'; msgEl.textContent = 'Pilih kategori.'; return;
      }
      if (!val || isNaN(val) || val <= 0){
        msgEl.style.color = 'crimson'; msgEl.textContent = 'Masukkan target volume valid (>0).'; return;
      }

      try {
        // upsert: if a category exists, insert new row (we'll insert new); if prefer upsert by category unique, change to upsert
        const { error } = await supabase.from('targets').upsert([{ category: cat, target_volume: val }], { onConflict: ['category'] });
        if (error) throw error;
        msgEl.style.color = 'green'; msgEl.textContent = '‚úÖ Target tersimpan.';
        // refresh
        setTimeout(()=>{ loadAll(); showTab('dashboard'); }, 800);
      } catch(err){
        console.error('save target err', err);
        msgEl.style.color = 'crimson'; msgEl.textContent = 'Gagal menyimpan target.';
      }
    });

    // refresh button in form
    document.getElementById('refreshBtn').addEventListener('click', ()=> loadAll());

    // initial load
    loadAll();

    // show default tab
    showTab('dashboard');
  </script>
</body>
</html>
