<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ“Š Dashboard Pelaporan</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #007bff;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    nav {
      background: #f1f1f1;
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    section {
      display: none;
      background: white;
      padding: 20px;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    section.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    select, input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 200px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <header>ðŸ“Š Dashboard Pelaporan</header>

  <nav>
    <button onclick="showTab('dashboard')">Dashboard</button>
    <button onclick="showTab('setTarget')">Set Target</button>
    <button onclick="showTab('boq')">BOQ</button>
    <button onclick="showTab('detailProgres')">Detail Progres</button>
  </nav>

  <!-- Dashboard -->
  <section id="dashboard" class="active">
    <h2>Grafik Capaian Target</h2>
    <canvas id="chartProgress" height="120"></canvas>
  </section>

  <!-- Set Target -->
  <section id="setTarget">
    <h2>Set Target Berdasarkan Kategori</h2>
    <label>Kategori:</label>
    <select id="categoryDropdown">
      <option value="Jalan">Jalan</option>
      <option value="Tiang">Tiang</option>
      <option value="Jembatan">Jembatan</option>
      <option value="Kabel">Kabel</option>
      <option value="Galian">Galian</option>
      <option value="Lain-Lain">Lain-Lain</option>
    </select><br>
    <label>Target Volume:</label>
    <input type="number" id="targetVolume" placeholder="Masukkan target volume">
    <button id="saveTarget">Simpan Target</button>
  </section>

  <!-- BOQ -->
  <section id="boq">
    <h2>Template BOQ</h2>
    <div id="boqList"></div>
  </section>

  <!-- Detail Progres -->
  <section id="detailProgres">
    <h2>Detail Progres Pekerjaan</h2>
    <table id="reportsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Kategori</th>
          <th>Nama Pekerjaan</th>
          <th>Volume</th>
          <th>Material</th>
          <th>Keterangan</th>
          <th>Foto Sebelum</th>
          <th>Foto Sesudah</th>
          <th>Telegram</th>
          <th>Dibuat</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    // ==================== SUPABASE SETUP ====================
    const SUPABASE_URL = "https://zpcuzrifbisrcjtqgqyv.supabase.co"; // Ganti dengan project kamu
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg"; // Ganti dengan anon key kamu
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ==================== NAVIGASI TAB ====================
    function showTab(tabId) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
    }
    window.showTab = showTab; // biar tombol bisa akses fungsi ini

    // ==================== DASHBOARD ====================
    async function loadDashboard() {
      const { data: reports } = await supabase.from("reports").select("*");
      const { data: targets } = await supabase.from("targets").select("*");
      if (!reports?.length || !targets?.length) return;

      const totals = {};
      reports.forEach(r => {
        const cat = r.category || "Lainnya";
        totals[cat] = (totals[cat] || 0) + (parseFloat(r.volume_pekerjaan) || 0);
      });

      const categories = targets.map(t => t.category);
      const progress = categories.map(cat => {
        const total = totals[cat] || 0;
        const target = parseFloat(targets.find(t => t.category === cat)?.target_volume || 1);
        return ((total / target) * 100).toFixed(1);
      });

      const ctx = document.getElementById("chartProgress").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: categories,
          datasets: [{
            label: "Persentase Capaian (%)",
            data: progress,
            backgroundColor: "#007bff"
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    // ==================== SET TARGET ====================
    document.getElementById("saveTarget").onclick = async () => {
      const category = document.getElementById("categoryDropdown").value;
      const target = document.getElementById("targetVolume").value;
      if (!category || !target) return alert("Lengkapi data terlebih dahulu!");
      const { error } = await supabase.from("targets").upsert({ category, target_volume: target });
      if (error) return alert("Gagal menyimpan target!");
      alert("Target berhasil disimpan!");
      await loadDashboard();
    };

    // ==================== BOQ (STORAGE templates) ====================
    async function loadBOQ() {
      const { data, error } = await supabase.storage.from("templates").list();
      if (error) return console.error(error);
      const list = document.getElementById("boqList");
      list.innerHTML = data.map(file => {
        const url = supabase.storage.from("templates").getPublicUrl(file.name).data.publicUrl;
        return `<p>ðŸ“„ <a href="${url}" target="_blank">${file.name}</a></p>`;
      }).join("");
    }

    // ==================== DETAIL PROGRES ====================
    async function loadReports() {
      const { data, error } = await supabase.from("reports").select("*");
      if (error) return console.error(error);
      const tbody = document.querySelector("#reportsTable tbody");
      tbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.category}</td>
          <td>${r.nama_pekerjaan}</td>
          <td>${r.volume_pekerjaan}</td>
          <td>${r.material}</td>
          <td>${r.keterangan || ""}</td>
          <td><a href="${r.photo_before_url}" target="_blank">Lihat</a></td>
          <td><a href="${r.photo_after_url}" target="_blank">Lihat</a></td>
          <td>${r.telegram_username || ""}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
        </tr>
      `).join("");
    }

    // ==================== LOAD AWAL ====================
    document.addEventListener("DOMContentLoaded", async () => {
      await loadDashboard();
      await loadBOQ();
      await loadReports();
      console.log("âœ… Dashboard siap digunakan");
    });
  </script>
</body>
</html>
