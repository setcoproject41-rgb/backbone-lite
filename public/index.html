<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Kemajuan Project</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: #f5f6fa;
      color: #333;
    }
    header {
      background: #4b3efc;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 18px; margin: 0; }
    nav a {
      color: white;
      margin-left: 15px;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    nav a.active { text-decoration: underline; }
    main { padding: 20px; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .summary div {
      flex: 1;
      background: #f9f9ff;
      border-radius: 8px;
      text-align: center;
      padding: 10px;
    }
    .summary div h3 { margin: 5px 0; font-size: 24px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 8px;
      font-size: 13px;
      text-align: left;
    }
    th { background: #fafafa; }
    img {
      border-radius: 5px;
      width: 80px;
      height: 80px;
      object-fit: cover;
    }
    footer {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Dashboard Kemajuan Project</h1>
    <nav>
      <a class="active" onclick="showTab('dashboard')">Dashboard</a>
      <a onclick="showTab('settarget')">Set Target</a>
      <a onclick="showTab('detail')">Detail Progress</a>
    </nav>
  </header>  <main>
    <!-- DASHBOARD -->
    <section id="dashboardTab" class="card">
      <h2>ðŸ“ˆ Ringkasan Kemajuan</h2>
      <div class="summary">
        <div><p>Total Progress</p><h3 id="totalProgress">0 m</h3></div>
        <div><p>% Capaian</p><h3 id="percentProgress">0%</h3></div>
        <div><p>Hari ke-</p><h3 id="dayProgress">0 / 60</h3></div>
      </div>
    </section><section class="card">
  <h2>ðŸ“Š Grafik Batang per Kategori</h2>
  <canvas id="categoryChart" height="120"></canvas>
</section>

<!-- DETAIL -->
<section id="detailTab" class="card" style="display:none;">
  <h2>ðŸ“‹ Detail Progress</h2>
  <table id="reportTable">
    <thead>
      <tr>
        <th>Kategori</th>
        <th>Pekerjaan</th>
        <th>Volume</th>
        <th>Material</th>
        <th>Keterangan</th>
        <th>Before</th>
        <th>After</th>
        <th>Petugas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- SET TARGET -->
<section id="settargetTab" class="card" style="display:none;">
  <h2>ðŸŽ¯ Set Target</h2>
  <p>Fitur input target akan dikembangkan berikutnya.</p>
</section>

  </main>  <footer>Â© 2025 Dashboard Project - Backbone Lite</footer>  <script>
    // === Inisialisasi Supabase ===
    const SUPABASE_URL = "https://zpcuzrifbisrcjtqgqyv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === Load Data ===
    async function loadDashboard() {
      const { data: reports, error: errReports } = await sb.from("reports").select("*");
      const { data: targets, error: errTargets } = await sb.from("targets").select("*");

      if (errReports) {
        console.error("Error reports:", errReports);
        return;
      }
      if (errTargets) console.warn("Warning: tidak ada tabel target:", errTargets);

      renderDashboard(reports, targets || []);
      renderTable(reports);
      renderChart(reports);
    }

    // === Ringkasan ===
    function renderDashboard(reports, targets) {
      const totalVolume = reports.reduce((sum, r) => sum + (parseFloat(r.volume_pekerjaan) || 0), 0);
      const totalTarget = targets.reduce((sum, t) => sum + (parseFloat(t.target_volume) || 0), 0);
      const percent = totalTarget ? ((totalVolume / totalTarget) * 100).toFixed(1) : 0;

      document.getElementById("totalProgress").innerText = totalVolume.toLocaleString() + " m";
      document.getElementById("percentProgress").innerText = percent + "%";
      document.getElementById("dayProgress").innerText = "2 / 60";
    }

    // === Tabel ===
    function renderTable(reports) {
      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      reports.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.category || "-"}</td>
          <td>${r.nama_pekerjaan || "-"}</td>
          <td>${r.volume_pekerjaan || "-"}</td>
          <td>${r.material || "-"}</td>
          <td>${r.keterangan || "-"}</td>
          <td><img src="${r.photo_before_url || ""}" alt="-" /></td>
          <td><img src="${r.photo_after_url || ""}" alt="-" /></td>
          <td>${r.telegram_name || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === Grafik ===
    let chartInstance;
    function renderChart(reports) {
      const ctx = document.getElementById("categoryChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      const grouped = reports.reduce((acc, r) => {
        const key = r.category || "Lain-Lain";
        acc[key] = (acc[key] || 0) + (parseFloat(r.volume_pekerjaan) || 0);
        return acc;
      }, {});

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: "Volume Pekerjaan (m)",
            data: Object.values(grouped),
            backgroundColor: "#4b3efc"
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    // === Navigasi Tab ===
    function showTab(tab) {
      document.getElementById("dashboardTab").style.display = tab === "dashboard" ? "block" : "none";
      document.getElementById("detailTab").style.display = tab === "detail" ? "block" : "none";
      document.getElementById("settargetTab").style.display = tab === "settarget" ? "block" : "none";
      document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
      document.querySelector(`nav a[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    // === Jalankan ===
    loadDashboard();
  </script></body>
</html>
