<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Kemajuan Project</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: #f5f6fa;
      color: #333;
    }
    header {
      background: #4b3efc;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 18px; margin: 0; }
    nav a {
      color: white;
      margin-left: 15px;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    nav a.active { text-decoration: underline; }
    main { padding: 20px; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .summary div {
      flex: 1;
      background: #f9f9ff;
      border-radius: 8px;
      text-align: center;
      padding: 10px;
    }
    .summary div h3 { margin: 5px 0; font-size: 22px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 8px;
      font-size: 13px;
      text-align: left;
    }
    th { background: #fafafa; }
    img {
      border-radius: 5px;
      width: 70px;
      height: 70px;
      object-fit: cover;
    }
    footer {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 12px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    input, select, button {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #4b3efc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #3a2ed0; }
    .msg {
      margin-top: 10px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Dashboard Kemajuan Project</h1>
    <nav>
      <a class="active" onclick="showTab('dashboard')">Dashboard</a>
      <a onclick="showTab('settarget')">Set Target</a>
      <a onclick="showTab('detail')">Detail Progress</a>
    </nav>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboardTab" class="card">
      <h2>üìà Ringkasan Kemajuan</h2>
      <div class="summary">
        <div><p>Penarikan</p><h3 id="progressPenarikan">0%</h3></div>
        <div><p>Galian</p><h3 id="progressGalian">0%</h3></div>
        <div><p>Tanam Tiang</p><h3 id="progressTiang">0%</h3></div>
        <div><p>Total Progres</p><h3 id="totalProgress">0%</h3></div>
      </div>
    </section>

    <section class="card">
      <h2>üìâ Grafik Kurva Kemajuan</h2>
      <canvas id="progressCurve" height="120"></canvas>
    </section>

    <section class="card">
      <h2>üìä Grafik Batang per Kategori</h2>
      <canvas id="categoryChart" height="120"></canvas>
    </section>

    <!-- DETAIL -->
    <section id="detailTab" class="card" style="display:none;">
      <h2>üìã Detail Progress</h2>
      <table id="reportTable">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Kategori</th>
            <th>Pekerjaan</th>
            <th>Volume</th>
            <th>Material</th>
            <th>Keterangan</th>
            <th>Before</th>
            <th>After</th>
            <th>Lokasi</th>
            <th>Petugas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SET TARGET -->
    <section id="settargetTab" class="card" style="display:none;">
      <h2>üéØ Set Target</h2>
      <form id="targetForm">
        <label>Kategori:</label>
        <select id="category">
          <option value="">-- Pilih Kategori --</option>
          <option value="Penarikan">Penarikan</option>
          <option value="Galian">Galian</option>
          <option value="Tanam Tiang">Tanam Tiang</option>
          <option value="Lain-Lain">Lain-Lain</option>
        </select>

        <label>Target Volume (m):</label>
        <input type="number" id="targetVolume" placeholder="contoh: 5000" />

        <button type="submit">Simpan Target</button>
      </form>
      <div id="targetMessage" class="msg"></div>
    </section>
  </main>

  <footer>¬© 2025 Dashboard Project - Backbone Lite</footer>

  <script>
    // === Supabase Config ===
    const SUPABASE_URL = "https://zpcuzrifbisrcjtqgqyv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3V6cmlmYmlzcmNqdHFncXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTYyMTcsImV4cCI6MjA3NzQ5MjIxN30.BQnuSVPu7rfKyPwZpZUwD5e4bUepFrrKHPzZhpq8OCg";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadDashboard() {
      const { data: reports, error: errReports } = await sb.from("reports").select("*");
      const { data: targets, error: errTargets } = await sb.from("targets").select("*");
      if (errReports) return console.error("Error reports:", errReports);

      renderSummary(reports, targets || []);
      renderCurve(reports);
      renderBarChart(reports);
      renderTable(reports);
    }

    // === RINGKASAN ===
    function renderSummary(reports, targets) {
      const categories = ["Penarikan", "Galian", "Tanam Tiang"];
      let totalVol = 0, totalTarget = 0;

      categories.forEach(cat => {
        const vol = reports.filter(r => (r.category || "").toLowerCase() === cat.toLowerCase())
          .reduce((sum, r) => sum + (parseFloat(r.volume_pekerjaan) || 0), 0);
        const targetObj = targets.find(t => (t.category || "").toLowerCase() === cat.toLowerCase());
        const targetVol = targetObj ? parseFloat(targetObj.target_volume) : 0;

        const percent = targetVol ? ((vol / targetVol) * 100).toFixed(1) : 0;
        document.getElementById(`progress${cat.replace(" ", "")}`).textContent = percent + "%";

        totalVol += vol;
        totalTarget += targetVol;
      });

      const totalPercent = totalTarget ? ((totalVol / totalTarget) * 100).toFixed(1) : 0;
      document.getElementById("totalProgress").textContent = totalPercent + "%";
    }

    // === GRAFIK KURVA ===
    let curveChart;
    function renderCurve(reports) {
      const ctx = document.getElementById("progressCurve").getContext("2d");
      if (curveChart) curveChart.destroy();

      const sorted = reports.sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
      const dates = sorted.map(r => new Date(r.created_at).toLocaleDateString("id-ID"));
      let total = 0;
      const progress = sorted.map(r => total += (parseFloat(r.volume_pekerjaan) || 0));

      curveChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label: "Kemajuan Volume (m)",
            data: progress,
            borderColor: "#4b3efc",
            fill: false,
            tension: 0.2
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    // === GRAFIK BATANG ===
    let barChart;
    function renderBarChart(reports) {
      const ctx = document.getElementById("categoryChart").getContext("2d");
      if (barChart) barChart.destroy();

      const grouped = reports.reduce((acc, r) => {
        const key = r.category || "Lain-Lain";
        acc[key] = (acc[key] || 0) + (parseFloat(r.volume_pekerjaan) || 0);
        return acc;
      }, {});

      barChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: "Volume (m)",
            data: Object.values(grouped),
            backgroundColor: "#4b3efc"
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    // === TABEL DETAIL ===
    function renderTable(reports) {
      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      reports.forEach(r => {
        const waktu = r.created_at ? new Date(r.created_at).toLocaleString("id-ID") : "-";
        const lokasi = (r.latitude && r.longitude)
          ? `<a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank">üìç Lihat</a>` : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${waktu}</td>
          <td>${r.category || "-"}</td>
          <td>${r.nama_pekerjaan || "-"}</td>
          <td>${r.volume_pekerjaan || 0}</td>
          <td>${r.material || "-"}</td>
          <td>${r.keterangan || "-"}</td>
          <td><img src="${r.photo_before_url || ''}" /></td>
          <td><img src="${r.photo_after_url || ''}" /></td>
          <td>${lokasi}</td>
          <td>${r.telegram_name || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === FORM TARGET ===
    document.getElementById("targetForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const category = document.getElementById("category").value;
      const volume = parseFloat(document.getElementById("targetVolume").value);
      const msg = document.getElementById("targetMessage");

      if (!category || !volume) {
        msg.style.color = "red";
        msg.textContent = "‚ö†Ô∏è Harap isi semua kolom.";
        return;
      }

      const { error } = await sb.from("targets").insert([{ category, target_volume: volume }]);
      if (error) {
        console.error(error);
        msg.style.color = "red";
        msg.textContent = "‚ùå Gagal menyimpan target.";
      } else {
        msg.style.color = "green";
        msg.textContent = "‚úÖ Target berhasil disimpan!";
        document.getElementById("targetForm").reset();
        setTimeout(() => {
          msg.textContent = "";
          loadDashboard();
          showTab("dashboard");
        }, 1000);
      }
    });

    // === NAVIGASI ===
    function showTab(tab) {
      document.getElementById("dashboardTab").style.display = tab === "dashboard" ? "block" : "none";
      document.getElementById("detailTab").style.display = tab === "detail" ? "block" : "none";
      document.getElementById("settargetTab").style.display = tab === "settarget" ? "block" : "none";
      document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
      document.querySelector(`nav a[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    loadDashboard();
  </script>
</body>
</html>
